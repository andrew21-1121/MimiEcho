name: MimiEcho Weekly Summary

on:
  # ── Automatic: Every Saturday at 4:00 PM KST (07:00 UTC) ─────────────────
  schedule:
    - cron: "0 5 * * 6"

  # ── Manual trigger from GitHub Actions UI ────────────────────────────────
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (scrape only, no Discord send)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  summarize:
    name: Scrape → Summarize → Notify
    runs-on: ubuntu-latest

    permissions:
      contents: write   # Required to commit updated last_processed_id.txt

    steps:
      # ── 1. Checkout repo ─────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ── 2. Set up Python ─────────────────────────────────────────────
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # ── 3. Install Python dependencies ───────────────────────────────
      - name: Install Python dependencies
        run: pip install --upgrade pip && pip install -r requirements.txt

      # ── 4. Install Playwright + Chromium ─────────────────────────────
      - name: Install Playwright browsers
        run: |
          playwright install chromium
          playwright install-deps chromium

      # ── 5. Run MimiEcho ──────────────────────────────────────────────
      - name: Run MimiEcho
        env:
          NAVER_COOKIES: ${{ secrets.NAVER_COOKIES }}
          CAFE_URL_NAME: ${{ secrets.CAFE_URL_NAME }}
          CAFE_BOARD_ID: ${{ secrets.CAFE_BOARD_ID }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: python main.py

      # ── 6. Commit updated state file ─────────────────────────────────
      - name: Commit updated last_processed_id.txt
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add last_processed_id.txt
          # Only commit if the file actually changed
          git diff --staged --quiet || git commit -m "chore: update last_processed_id [skip ci]"
          git push
